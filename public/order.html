<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>注文入力 | MateCook</title>
<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"/>
<style>
:root{--bg:#0f0f0f;--fg:#f0f0f0;--muted:#1f1f1f;--border:#333;
      --card:#1b1b1b;--card-border:#444;}
html,body{background:var(--bg);color:var(--fg);}
main{max-width:480px;margin-inline:auto;padding-block:1rem;}
h1{color:#fff;font-size:1.7rem;margin-bottom:.5rem;}
label,h2{color:#ddd}
.menu-grid{display:grid;gap:.75rem;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));}
.menu-card{
  background:var(--card);border:1px solid var(--card-border);
  border-radius:.6rem;padding:.75rem;display:flex;flex-direction:column;align-items:center;
}
.menu-card strong{color:#fff;}
.qty-wrap{display:flex;gap:.3rem;align-items:center;margin-top:.5rem;}
.qty-btn{width:32px;height:32px;line-height:30px;text-align:center;
  border:1px solid var(--card-border);border-radius:6px;cursor:pointer;background:#2a2a2a;color:#fff;}
.qty-input{width:48px;text-align:center;border:none;font-weight:bold;font-size:1.2rem;background:transparent;color:#fff;}
dialog{max-width:90%;background:var(--muted);color:var(--fg);}

/* --- 数字入力のスピナーを隠す --- */
/* ── 数字入力 ↑↓ スピナー非表示 ── */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type="number"] {      /* Firefox */
  -moz-appearance: textfield;
}


</style>
</head>
<body>
<main class="container">
  <h1>オーダー入力</h1>

  <label>テーブル No.
    <input type="number" id="tableNo" min="1" placeholder="例: 5" required>
  </label>

  <h2>メニュー & 個数</h2>
  <div id="menuGrid" class="menu-grid"></div>

  <button id="confirmBtn" class="contrast" style="width:100%;">送信確認</button>
</main>

<!-- 確認モーダル -->
<dialog id="confirmDialog">
  <article>
    <h3>以下で誤りありませんか？</h3>
    <div id="orderSummary"></div>
    <footer style="display:flex;gap:1rem;justify-content:flex-end;">
      <button id="cancelDialog" class="secondary">キャンセル</button>
      <button id="sendOrder" class="contrast">送信</button>
    </footer>
  </article>
</dialog>

<script type="module">
/* ==== Firebase init ==== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, getDocs }
  from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
import { getAuth, signInAnonymously }
  from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
import { firebaseConfig } from "./firebase-config.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
await signInAnonymously(getAuth(app));

/* ==== メニュー取得 & UI生成 ==== */
const menuGrid = document.getElementById("menuGrid");
let MENUS = [];
await loadMenus();

async function loadMenus(){
  const snap = await getDocs(collection(db,"menus"));
  menuGrid.innerHTML=""; MENUS=[];
  snap.forEach(d=>{
    const m={id:d.id,name:d.data().name};
    MENUS.push(m);
    const card=document.createElement("div");
    card.className="menu-card";
    card.innerHTML=`
      <strong>${m.name}</strong>
      <div class="qty-wrap">
        <span class="qty-btn" data-op="-" data-id="${m.id}">－</span>
        <input type="number" class="qty-input" id="qty-${m.id}" value="0" min="0" readonly>
        <span class="qty-btn" data-op="+" data-id="${m.id}">＋</span>
      </div>`;
    menuGrid.appendChild(card);
  });
}

/* ==== 数量 +/- ==== */
menuGrid.addEventListener("click",e=>{
  if(!e.target.classList.contains("qty-btn"))return;
  const {op,id}=e.target.dataset;
  const inp=document.getElementById(`qty-${id}`);
  let v=Number(inp.value);
  v = op==="+"?v+1:Math.max(0,v-1);
  inp.value = v;
});

/* ==== モーダル ==== */
const dialog=document.getElementById("confirmDialog");
const summary=document.getElementById("orderSummary");

document.getElementById("confirmBtn").onclick=()=>{
  const tableNo=document.getElementById("tableNo").value.trim();
  if(!tableNo){alert("テーブル番号を入力してください");return;}
  const items=MENUS.map(m=>{
    const q=Number(document.getElementById(`qty-${m.id}`).value);
    return q>0?{...m,qty:q}:null;}).filter(Boolean);
  if(!items.length){alert("最低1品は選択してください");return;}
  summary.innerHTML=`<p><strong>テーブル:</strong> ${tableNo}</p><ul>${
    items.map(i=>`<li>${i.name} × ${i.qty}</li>`).join("")}</ul>`;
  dialog.showModal();
};
document.getElementById("cancelDialog").onclick=()=>dialog.close();

/* ==== 送信 ==== */
document.getElementById("sendOrder").onclick=async()=>{
  const tableNo=document.getElementById("tableNo").value.trim();
  const items=MENUS.map(m=>{
    const q=Number(document.getElementById(`qty-${m.id}`).value);
    return q>0?{menuId:m.id,qty:q}:null;}).filter(Boolean);
  try{
    await addDoc(collection(db,"orders"),{
      tableNo,items,status:"pending",createdAt:serverTimestamp(),cookId:""
    });
    dialog.close(); alert("送信完了！");
    document.getElementById("tableNo").value="";
    MENUS.forEach(m=>document.getElementById(`qty-${m.id}`).value=0);
  }catch(e){alert("送信失敗: "+e.message);}
};
</script>
</body>
</html>
